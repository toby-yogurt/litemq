package main

import (
	"fmt"
	"sync"
	"time"

	"litemq/pkg/broker"
)

// Task ç¤ºä¾‹ä»»åŠ¡
type Task struct {
	ID        string
	Name      string
	DelayTime int64 // å»¶æ—¶æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
}

func main() {
	fmt.Println("=== æ—¶é—´è½®ï¼ˆTimeWheelï¼‰ç¤ºä¾‹ ===\n")

	// åˆ›å»ºå¤šå±‚æ—¶é—´è½®
	timeWheel := broker.NewTimeWheel()

	// ç”¨äºå­˜å‚¨ä»»åŠ¡çš„æ˜ å°„ï¼ˆæ¨¡æ‹Ÿ CommitLogï¼‰
	tasks := make(map[int64]*Task)
	taskMutex := sync.RWMutex{}

	// ä»»åŠ¡è®¡æ•°å™¨ï¼ˆæ¨¡æ‹Ÿ CommitLogOffsetï¼‰
	taskCounter := int64(0)

	// è®¾ç½®æ¶ˆæ¯åˆ°æœŸå›è°ƒå‡½æ•°
	timeWheel.SetExpireCallback(func(offset int64) {
		taskMutex.RLock()
		task, exists := tasks[offset]
		taskMutex.RUnlock()

		if !exists {
			fmt.Printf("âŒ [å›è°ƒ] ä»»åŠ¡ä¸å­˜åœ¨: offset=%d\n", offset)
			return
		}

		now := time.Now()
		actualDelay := now.Sub(time.UnixMilli(task.DelayTime))
		fmt.Printf("âœ… [åˆ°æœŸ] ä»»åŠ¡æ‰§è¡Œ: %s (ID: %s, è®¡åˆ’å»¶æ—¶: %v, å®é™…å»¶æ—¶: %v)\n",
			task.Name, task.ID, time.UnixMilli(task.DelayTime).Format("15:04:05"), actualDelay.Round(time.Second))

		// æ¸…ç†ä»»åŠ¡
		taskMutex.Lock()
		delete(tasks, offset)
		taskMutex.Unlock()
	})

	// å¯åŠ¨æ—¶é—´è½®
	if err := timeWheel.Start(); err != nil {
		fmt.Printf("å¯åŠ¨æ—¶é—´è½®å¤±è´¥: %v\n", err)
		return
	}
	defer timeWheel.Stop()

	fmt.Println("æ—¶é—´è½®å·²å¯åŠ¨ï¼Œå¼€å§‹æ·»åŠ å»¶æ—¶ä»»åŠ¡...\n")

	// ç¤ºä¾‹1: æ·»åŠ 5ç§’åæ‰§è¡Œçš„ä»»åŠ¡
	now := time.Now()
	task1 := &Task{
		ID:        "task-1",
		Name:      "5ç§’åæ‰§è¡Œçš„ä»»åŠ¡",
		DelayTime: now.Add(5 * time.Second).UnixMilli(),
	}
	taskCounter++
	tasks[taskCounter] = task1
	timeWheel.AddMessage(task1.DelayTime, taskCounter)
	fmt.Printf("ğŸ“Œ [æ·»åŠ ] %s (å°†åœ¨ %s æ‰§è¡Œ)\n", task1.Name, time.UnixMilli(task1.DelayTime).Format("15:04:05"))

	// ç¤ºä¾‹2: æ·»åŠ 10ç§’åæ‰§è¡Œçš„ä»»åŠ¡
	task2 := &Task{
		ID:        "task-2",
		Name:      "10ç§’åæ‰§è¡Œçš„ä»»åŠ¡",
		DelayTime: now.Add(10 * time.Second).UnixMilli(),
	}
	taskCounter++
	tasks[taskCounter] = task2
	timeWheel.AddMessage(task2.DelayTime, taskCounter)
	fmt.Printf("ğŸ“Œ [æ·»åŠ ] %s (å°†åœ¨ %s æ‰§è¡Œ)\n", task2.Name, time.UnixMilli(task2.DelayTime).Format("15:04:05"))

	// ç¤ºä¾‹3: æ·»åŠ 30ç§’åæ‰§è¡Œçš„ä»»åŠ¡ï¼ˆè·¨åˆ†é’Ÿè¾¹ç•Œï¼‰
	task3 := &Task{
		ID:        "task-3",
		Name:      "30ç§’åæ‰§è¡Œçš„ä»»åŠ¡",
		DelayTime: now.Add(30 * time.Second).UnixMilli(),
	}
	taskCounter++
	tasks[taskCounter] = task3
	timeWheel.AddMessage(task3.DelayTime, taskCounter)
	fmt.Printf("ğŸ“Œ [æ·»åŠ ] %s (å°†åœ¨ %s æ‰§è¡Œ)\n", task3.Name, time.UnixMilli(task3.DelayTime).Format("15:04:05"))

	// ç¤ºä¾‹4: æ·»åŠ 2åˆ†é’Ÿåæ‰§è¡Œçš„ä»»åŠ¡ï¼ˆåˆ†é’Ÿçº§æ—¶é—´è½®ï¼‰
	task4 := &Task{
		ID:        "task-4",
		Name:      "2åˆ†é’Ÿåæ‰§è¡Œçš„ä»»åŠ¡",
		DelayTime: now.Add(2 * time.Minute).UnixMilli(),
	}
	taskCounter++
	tasks[taskCounter] = task4
	timeWheel.AddMessage(task4.DelayTime, taskCounter)
	fmt.Printf("ğŸ“Œ [æ·»åŠ ] %s (å°†åœ¨ %s æ‰§è¡Œ)\n", task4.Name, time.UnixMilli(task4.DelayTime).Format("15:04:05"))

	// ç¤ºä¾‹5: æ·»åŠ 1å°æ—¶åæ‰§è¡Œçš„ä»»åŠ¡ï¼ˆå°æ—¶çº§æ—¶é—´è½®ï¼‰
	task5 := &Task{
		ID:        "task-5",
		Name:      "1å°æ—¶åæ‰§è¡Œçš„ä»»åŠ¡",
		DelayTime: now.Add(1 * time.Hour).UnixMilli(),
	}
	taskCounter++
	tasks[taskCounter] = task5
	timeWheel.AddMessage(task5.DelayTime, taskCounter)
	fmt.Printf("ğŸ“Œ [æ·»åŠ ] %s (å°†åœ¨ %s æ‰§è¡Œ)\n", task5.Name, time.UnixMilli(task5.DelayTime).Format("15:04:05"))

	fmt.Println("\nç­‰å¾…ä»»åŠ¡æ‰§è¡Œ...\n")

	// ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œè§‚å¯Ÿä»»åŠ¡æ‰§è¡Œ
	time.Sleep(35 * time.Second)

	fmt.Println("\n=== æ—¶é—´è½®å·¥ä½œåŸç†è¯´æ˜ ===")
	printTimeWheelExplanation()

	// ç»§ç»­ç­‰å¾…ï¼Œè§‚å¯Ÿæ›´é•¿æ—¶é—´çš„ä»»åŠ¡
	fmt.Println("\nç»§ç»­ç­‰å¾…ï¼Œè§‚å¯Ÿæ›´é•¿æ—¶é—´çš„ä»»åŠ¡æ‰§è¡Œ...")
	time.Sleep(2 * time.Minute)
}

// printTimeWheelExplanation æ‰“å°æ—¶é—´è½®å·¥ä½œåŸç†è¯´æ˜
func printTimeWheelExplanation() {
	fmt.Println(`
æ—¶é—´è½®æ˜¯ä¸€ä¸ªç¯å½¢æ•°ç»„ï¼Œæ¯ä¸ªæ§½ä½ä»£è¡¨ä¸€ä¸ªæ—¶é—´é—´éš”ã€‚

å¤šå±‚æ—¶é—´è½®ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬0å±‚ï¼ˆç§’çº§ï¼‰- 60ä¸ªæ§½ä½ï¼Œæ¯ä¸ª1ç§’         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚  0  â”‚  1  â”‚  2  â”‚ ... â”‚ 59  â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  æ¯ç§’æ¨è¿›ä¸€ä¸ªæ§½ä½                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å±‚ï¼ˆåˆ†é’Ÿçº§ï¼‰- 60ä¸ªæ§½ä½ï¼Œæ¯ä¸ª1åˆ†é’Ÿ     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚  0  â”‚  1  â”‚  2  â”‚ ... â”‚ 59  â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  æ¯60ç§’æ¨è¿›ä¸€ä¸ªæ§½ä½                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬2å±‚ï¼ˆå°æ—¶çº§ï¼‰- 24ä¸ªæ§½ä½ï¼Œæ¯ä¸ª1å°æ—¶     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”              â”‚
â”‚ â”‚  0  â”‚  1  â”‚  2  â”‚ ... â”‚              â”‚
â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜              â”‚
â”‚  æ¯60åˆ†é’Ÿæ¨è¿›ä¸€ä¸ªæ§½ä½                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬3å±‚ï¼ˆå¤©çº§ï¼‰- 365ä¸ªæ§½ä½ï¼Œæ¯ä¸ª1å¤©        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”              â”‚
â”‚ â”‚  0  â”‚  1  â”‚  2  â”‚ ... â”‚              â”‚
â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜              â”‚
â”‚  æ¯24å°æ—¶æ¨è¿›ä¸€ä¸ªæ§½ä½                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å·¥ä½œæµç¨‹ï¼š
1. æ·»åŠ æ¶ˆæ¯æ—¶ï¼Œæ ¹æ®å»¶æ—¶æ—¶é—´é€‰æ‹©åˆé€‚çš„å±‚çº§
2. è®¡ç®—æ¶ˆæ¯åº”è¯¥æ”¾åœ¨å“ªä¸ªæ§½ä½
3. æ—¶é—´è½®æ¯ç§’æ¨è¿›ï¼ˆåªå¯åŠ¨ç§’çº§æ—¶é—´è½®ï¼‰
4. å½“ç§’çº§æ—¶é—´è½®è½¬å®Œä¸€åœˆï¼ˆ60ç§’ï¼‰ï¼Œæ¨è¿›åˆ†é’Ÿçº§æ—¶é—´è½®
5. æ¶ˆæ¯ä»ç²—ç²’åº¦å±‚çº§é™çº§åˆ°ç»†ç²’åº¦å±‚çº§
6. å½“æ¶ˆæ¯åˆ°æœŸæ—¶ï¼Œè§¦å‘å›è°ƒå‡½æ•°

ä¼˜åŠ¿ï¼š
- O(1) æ—¶é—´å¤æ‚åº¦æ·»åŠ æ¶ˆæ¯
- O(1) æ—¶é—´å¤æ‚åº¦æ£€æŸ¥åˆ°æœŸæ¶ˆæ¯
- æ”¯æŒä»ç§’çº§åˆ°å¤©çº§çš„è¶…é•¿å»¶æ—¶
- å†…å­˜é«˜æ•ˆï¼Œåªå­˜å‚¨æ¶ˆæ¯åç§»é‡
`)
}
